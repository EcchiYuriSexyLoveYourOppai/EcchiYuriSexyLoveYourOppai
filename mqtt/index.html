<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MQTT Web Client</title>
    <script src="../js/mqtt.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        button { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <h1>MQTT Web Client</h1>
    
    <div id="status" class="status disconnected">未连接</div>
    
    <div>
        <label>服务器地址: </label>
        <input type="text" id="host" value="mqtt.husluo.com">
        <label>端口: </label>
        <input type="number" id="port" value="8083" style="width: 60px;">
    </div>
    
    <div style="margin: 15px 0;">
        <button id="connectBtn">连接</button>
        <button id="disconnectBtn" disabled>断开</button>
    </div>
    
    <div>
        <label>订阅主题: </label>
        <input type="text" id="subTopic" value="echo">
        <button id="subscribeBtn" disabled>订阅</button>
    </div>
    
    <div style="margin-top: 15px;">
        <label>发布主题: </label>
        <input type="text" id="pubTopic" value="control">
    </div>
    
    <div style="margin-top: 15px;">
        <label>发布消息: </label>
        <input type="text" id="message" value="oled">
        <button id="publishBtn" disabled>发布</button>
    </div>
    
    <h3>接收消息:</h3>
    <div id="messages"></div>

    <script>
        const client = {
            mqttClient: null,
            isConnected: false,
            reconnectAttempts: 0,
            
            connect: function() {
                const host = document.getElementById('host').value;
                const port = document.getElementById('port').value;
                const clientId = 'web_' + Math.random().toString(16).substr(2, 8);
                
                this.disconnect();
                
                try {
                    this.mqttClient = mqtt.connect(`mqtts://${host}/mqtt`, {
                        clientId: clientId,
                        port: port,
                        protocolVersion: 4
                    });
                    
                    this.bindEvents();
                    updateStatus('正在连接...');
                } catch (err) {
                    this.handleError(err);
                }
            },
            
            bindEvents: function() {
                if (!this.mqttClient) return;
                
                this.mqttClient.on('connect', () => {
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    updateStatus('已连接', true);
                    enableControls(true);

                if (this.mqttClient && this.isConnected) {
                    const topic = document.getElementById('subTopic').value;
                    this.mqttClient.subscribe(topic, { qos: 2 }, (err) => {
                        if (!err) {
                            addMessage('系统', `已订阅主题: ${topic}`);
                        }
                    });
                }

                });
                
                this.mqttClient.on('message', (topic, payload) => {
                    addMessage(topic, payload.toString());
                });
                
                this.mqttClient.on('error', (err) => {
                    this.handleError(err);
                });
                
                this.mqttClient.on('close', () => {
                    if (this.isConnected) {
                        this.reconnect();
                    }
                });
            },
            
            disconnect: function() {
                if (this.mqttClient) {
                    this.mqttClient.end(true);
                    this.mqttClient = null;
                    this.isConnected = false;
                    updateStatus('已断开', false);
                    enableControls(false);
                }
            },
            
            reconnect: function() {
                this.reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                setTimeout(() => this.connect(), delay);
            },
            
            handleError: function(err) {
                console.error('[MQTT Error]', err);
                updateStatus(err.message || '连接错误', false);
                this.reconnect();
            },
            
            subscribe: function() {
                if (this.mqttClient && this.isConnected) {
                    const topic = document.getElementById('subTopic').value;
                    this.mqttClient.subscribe(topic, { qos: 2 }, (err) => {
                        if (!err) {
                            addMessage('系统', `已订阅主题: ${topic}`);
                        }
                    });
                }
            },
            
            publish: function() {
                if (this.mqttClient && this.isConnected) {
                    const topic = document.getElementById('pubTopic').value;
                    const message = document.getElementById('message').value;
                    this.mqttClient.publish(topic, message, { qos: 2 });
                }
            }
        };
        
        function updateStatus(text, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = isConnected ? 'status connected' : 'status disconnected';
        }
        
        function enableControls(enable) {
            document.getElementById('connectBtn').disabled = enable;
            document.getElementById('disconnectBtn').disabled = !enable;
            document.getElementById('subscribeBtn').disabled = !enable;
            document.getElementById('publishBtn').disabled = !enable;
        }
        
        function addMessage(topic, payload) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.innerHTML = `<strong>${topic}:</strong> ${payload}`;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        document.getElementById('connectBtn').addEventListener('click', () => client.connect());
        document.getElementById('disconnectBtn').addEventListener('click', () => client.disconnect());
        document.getElementById('subscribeBtn').addEventListener('click', () => client.subscribe());
        document.getElementById('publishBtn').addEventListener('click', () => client.publish());
    </script>
</body>
</html>
